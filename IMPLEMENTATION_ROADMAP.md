# Implementation Roadmap - VertexAI Imagen MCP Server

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€VertexAI Imagen MCP Server ã®å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã§ã™ã€‚

## å®Œäº†æ¸ˆã¿

### âœ… Phase 1A: Multi-sample Generationï¼ˆè¤‡æ•°ç”»åƒç”Ÿæˆï¼‰
**å®Œäº†æ—¥**: 2025-10-12
**ãƒ–ãƒ©ãƒ³ãƒ**: digicatswork
**ã‚³ãƒŸãƒƒãƒˆ**: e239d5b

**å®Ÿè£…å†…å®¹**:
- `generate_image`: 1-4æšã®ç”»åƒç”Ÿæˆå¯¾å¿œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
- `edit_image`: 1-4æšã®ç”»åƒç”Ÿæˆå¯¾å¿œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
- `generateMultipleFilePaths()` é–¢æ•°: è‡ªå‹•ãƒŠãƒ³ãƒãƒªãƒ³ã‚°æ©Ÿèƒ½ï¼ˆimage_1.png, image_2.pngï¼‰
- `createMultiUriImageResponse()` é–¢æ•°: è¤‡æ•°ç”»åƒã®MCPãƒ¬ã‚¹ãƒãƒ³ã‚¹
- Resources API çµ±åˆï¼ˆfile:// URIï¼‰
- ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå¯¾å¿œ
- å¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼ˆsample_count=1 ã¯å¾“æ¥å½¢å¼ï¼‰

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
- src/utils/path.ts
- src/utils/image.ts
- src/types/tools.ts
- src/index.ts

---

### âœ… Phase 1A': customize_image Multi-sample Support
**å®Œäº†æ—¥**: 2025-10-12
**ãƒ–ãƒ©ãƒ³ãƒ**: digicatswork
**æ‰€è¦æ™‚é–“**: 30åˆ†

**å®Ÿè£…å†…å®¹**:
- `customize_image`: 1-4æšã®ç”»åƒç”Ÿæˆå¯¾å¿œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
- `generateMultipleFilePaths()` ã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•ãƒŠãƒ³ãƒãƒªãƒ³ã‚°
- `createMultiUriImageResponse()` ã«ã‚ˆã‚‹è¤‡æ•°ç”»åƒã®MCPãƒ¬ã‚¹ãƒãƒ³ã‚¹
- sample_count ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ1-4ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼‰
- å¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼ˆsample_count=1 ã¯å¾“æ¥å½¢å¼ï¼‰
- base64ãƒ¢ãƒ¼ãƒ‰æ™‚ã®è­¦å‘Šè¿½åŠ ï¼ˆè¤‡æ•°ç”»åƒæ™‚ï¼‰

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
- src/types/tools.ts: CustomizeImageArgs ã« sample_count è¿½åŠ 
- src/index.ts: Schemaå®šç¾©ã€customizeImage()é–¢æ•°ã®æ›´æ–°

**æ³¨æ„ç‚¹**:
- Reference images (control/subject/style) ã¨ã®çµ„ã¿åˆã‚ã›ã§ API åˆ¶é™ãŒã‚ã‚‹å¯èƒ½æ€§
- ç‰¹ã« non-square aspect ratio + è¤‡æ•° reference types ã®åˆ¶é™ã«æ³¨æ„ï¼ˆæ—¢å­˜ãƒã‚§ãƒƒã‚¯ç¶­æŒï¼‰

---

## å®Ÿè£…äºˆå®š

### Phase 1C: Resolution Selectionï¼ˆè§£åƒåº¦é¸æŠå¯¾å¿œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ ä¸­ï½é«˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã€æ—©æœŸå®Ÿè£…æ¨å¥¨ï¼‰
**æ‰€è¦æ™‚é–“**: 1æ™‚é–“
**ä¾å­˜é–¢ä¿‚**: ãªã—

**ç›®çš„**: ç”Ÿæˆç”»åƒã®å‡ºåŠ›è§£åƒåº¦ã‚’é¸æŠå¯èƒ½ã«ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‹ãƒ¼ã‚ºã«å¿œã˜ãŸå“è³ªåˆ¶å¾¡ã‚’å®Ÿç¾

**å®Ÿè£…å†…å®¹**:

1. **æ–°è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: `sampleImageSize`**
   - å‹: `string`
   - è¨±å¯å€¤: `"1K"` | `"2K"`
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `"1K"`
   - ç”¨é€”: ç”Ÿæˆç”»åƒã®å‡ºåŠ›è§£åƒåº¦ã‚’æŒ‡å®š

2. **å¯¾è±¡ãƒ„ãƒ¼ãƒ«**
   - `generate_image`: ç”»åƒç”Ÿæˆæ™‚ã®è§£åƒåº¦é¸æŠ
   - `edit_image`: ç”»åƒç·¨é›†æ™‚ã®è§£åƒåº¦é¸æŠ
   - `customize_image`: ç”»åƒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ™‚ã®è§£åƒåº¦é¸æŠ
   - `generate_and_upscale_image`: ç”Ÿæˆæ™‚ã®è§£åƒåº¦é¸æŠï¼ˆã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«å‰ï¼‰

3. **å‹å®šç¾©ã®æ›´æ–°**
   ```typescript
   // src/types/tools.ts
   export interface GenerateImageArgs {
     // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
     sample_count?: number;
     sample_image_size?: "1K" | "2K";  // è¿½åŠ 
   }

   export interface EditImageArgs {
     // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
     sample_count?: number;
     sample_image_size?: "1K" | "2K";  // è¿½åŠ 
   }

   export interface CustomizeImageArgs {
     // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
     sample_count?: number;
     sample_image_size?: "1K" | "2K";  // è¿½åŠ 
   }

   export interface GenerateAndUpscaleImageArgs {
     // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
     sample_image_size?: "1K" | "2K";  // è¿½åŠ 
   }
   ```

4. **ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã®æ›´æ–°**
   ```typescript
   // src/index.ts - å„ãƒ„ãƒ¼ãƒ«ã®inputSchemaã«è¿½åŠ 
   sample_image_size: {
     type: "string",
     enum: ["1K", "2K"],
     description: "Output resolution of generated image (default: 1K). 1K for faster generation, 2K for higher quality.",
   }
   ```

5. **API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®çµ±åˆ**
   - å„ç”Ÿæˆé–¢æ•°å†…ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ Imagen API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¿½åŠ 
   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: "1K" ã¾ãŸã¯ "2K" ä»¥å¤–ã®å€¤ã‚’æ‹’å¦
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å‡¦ç†ï¼ˆçœç•¥æ™‚ã¯ Imagen API ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ "1K" ã‚’ä½¿ç”¨ï¼‰

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/types/tools.ts`: å…¨ã¦ã®ç”Ÿæˆç³» Args ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«è¿½åŠ 
- `src/index.ts`: ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨å„ãƒ„ãƒ¼ãƒ«é–¢æ•°ã®æ›´æ–°

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå“è³ªã¨ç”Ÿæˆé€Ÿåº¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’åˆ¶å¾¡å¯èƒ½
- é«˜è§£åƒåº¦ãŒå¿…è¦ãªå ´åˆã« 2K ã‚’é¸æŠï¼ˆãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å‘ã‘ï¼‰
- ä½è§£åƒåº¦ã§é«˜é€Ÿãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆ1Kï¼‰
- å¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æ—¢å­˜ã®å‹•ä½œã‚’ä¿è¨¼ï¼‰

**æ³¨æ„ç‚¹**:
- 2K ç”Ÿæˆã¯ 1K ã‚ˆã‚Šæ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ã‚ã‚Š
- ã‚³ã‚¹ãƒˆé¢ã§ã®é•ã„ãŒã‚ã‚‹ã‹è¦ç¢ºèªï¼ˆGoogle Cloud ã®èª²é‡‘ä½“ç³»ï¼‰
- `upscale_image` ãƒ„ãƒ¼ãƒ«ã¨ã®ä½¿ã„åˆ†ã‘ã‚’æ˜ç¢ºåŒ–
  - å°ã•ã„è§£åƒåº¦ã§ç”Ÿæˆ â†’ upscaleï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰
  - æœ€åˆã‹ã‚‰é«˜è§£åƒåº¦ã§ç”Ÿæˆï¼ˆæ–°ã—ã„æ–¹æ³•ï¼‰

---

### Phase 1B: Asynchronous Job Managementï¼ˆéåŒæœŸã‚¸ãƒ§ãƒ–ç®¡ç†ï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ ä¸­ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ã«ã‚ˆã‚Šä¿¡é ¼æ€§å‘ä¸Šï¼‰
**æ‰€è¦æ™‚é–“**: 4-5æ™‚é–“ï¼ˆSQLiteçµ±åˆå«ã‚€ï¼‰
**ä¾å­˜é–¢ä¿‚**: Phase 2ã¨ã®çµ±åˆã‚’æ¨å¥¨

**ç›®çš„**: é•·æ™‚é–“å®Ÿè¡Œã®ã‚¸ãƒ§ãƒ–ã‚’éåŒæœŸã§ç®¡ç†ã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å›é¿ã™ã‚‹

**å®Ÿè£…å†…å®¹**:

1. **ã‚¸ãƒ§ãƒ–ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **
   ```typescript
   type JobType = 'generate' | 'edit' | 'customize' | 'upscale';
   type JobStatus = 'pending' | 'running' | 'completed' | 'failed';

   interface JobBase {
     id: string;
     type: JobType;
     status: JobStatus;
     createdAt: Date;
     startedAt?: Date;
     completedAt?: Date;
     error?: string;
   }

   interface GenerateJob extends JobBase {
     type: 'generate';
     params: GenerateImageArgs;
     result?: { outputPaths: string[] };
   }

   interface EditJob extends JobBase {
     type: 'edit';
     params: EditImageArgs;
     result?: { outputPaths: string[] };
   }

   interface CustomizeJob extends JobBase {
     type: 'customize';
     params: CustomizeImageArgs;
     result?: { outputPaths: string[] };
   }

   interface UpscaleJob extends JobBase {
     type: 'upscale';
     params: UpscaleImageArgs;
     result?: { outputPath: string };
   }

   type Job = GenerateJob | EditJob | CustomizeJob | UpscaleJob;
   ```

2. **æ–°è¦ãƒ„ãƒ¼ãƒ«**
   - `start_generation_job`: ã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹ã—ã¦IDã‚’è¿”ã™
     - å…¥åŠ›: å„ç¨®ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ + job_type
     - å‡ºåŠ›: job_id

   - `check_job_status`: ã‚¸ãƒ§ãƒ–ã®é€²è¡ŒçŠ¶æ³ç¢ºèª
     - å…¥åŠ›: job_id
     - å‡ºåŠ›: status, progress?, estimated_time?

   - `get_job_result`: å®Œäº†ã—ãŸã‚¸ãƒ§ãƒ–ã®çµæœå–å¾—
     - å…¥åŠ›: job_id
     - å‡ºåŠ›: ç”Ÿæˆç”»åƒã® URI ãªã©

   - `cancel_job`: ã‚¸ãƒ§ãƒ–ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
     - å…¥åŠ›: job_id
     - å‡ºåŠ›: success/failure

   - `list_jobs`: ã‚¸ãƒ§ãƒ–ä¸€è¦§è¡¨ç¤º
     - å…¥åŠ›: status?, limit?
     - å‡ºåŠ›: jobs[]

3. **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆPhase 2ã¨çµ±åˆæ¨å¥¨ï¼‰**
   - **æ¨å¥¨**: SQLiteçµ±åˆ
     - Phase 2ï¼ˆå±¥æ­´æ©Ÿèƒ½ï¼‰ã¨åŒã˜DBã‚’ä½¿ç”¨
     - ãƒ†ãƒ¼ãƒ–ãƒ«: `jobs` ã¨ `history` ã‚’åŒä¸€DBå†…ã«é…ç½®
     - ãƒ¡ãƒªãƒƒãƒˆ: å†èµ·å‹•è€æ€§ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹é›†è¨ˆã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
     - ãƒ‘ã‚¹: ç’°å¢ƒå¤‰æ•° `VERTEXAI_IMAGEN_DB` ã¾ãŸã¯ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ `./data/vertexai-imagen.db`
   - ä»£æ›¿æ¡ˆ: ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ï¼ˆMap<string, Job>ï¼‰
     - ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å‘ã‘ã€å†èµ·å‹•ã§æ¶ˆå¤±

4. **ãƒ¯ãƒ¼ã‚«ãƒ¼å®Ÿè£…**
   - Promise ãƒ™ãƒ¼ã‚¹ã®éåŒæœŸå®Ÿè¡Œ
   - åŒæ™‚å®Ÿè¡Œæ•°ã®åˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2-3ï¼‰
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆã‚¸ãƒ§ãƒ–å˜ä½ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›é¿ï¼ˆç‰¹ã« upscale ã‚„ multiple samplesï¼‰
- è¤‡æ•°ã‚¸ãƒ§ãƒ–ã®ä¸¦åˆ—å®Ÿè¡Œ
- UXå‘ä¸Šï¼ˆå³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
- ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å®Ÿè£…ãŒå®¹æ˜“
- **SQLiteçµ±åˆæ™‚**:
  - å†èµ·å‹•å¾Œã‚‚ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ã‚’ä¿æŒ
  - å±¥æ­´æ©Ÿèƒ½ã¨çµ±åˆã—ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹åˆ†æ
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ä¸€è²«æ€§ä¿è¨¼

**è€ƒæ…®äº‹é …**:
- å®Ÿè£…ã®è¤‡é›‘æ€§å¢—åŠ ï¼ˆPhase 2ã¨çµ±åˆã™ã‚‹ã“ã¨ã§è»½æ¸›ï¼‰
- ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ãŒå¿…è¦ï¼ˆSQLiteã§æ°¸ç¶šåŒ–ï¼‰
- MCP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒãƒ¼ãƒªãƒ³ã‚°ãŒå¿…è¦ï¼ˆéåŒæœŸã®åˆ¶ç´„ï¼‰

---

### Phase 2: UUID-based History Tracking & Metadata Integrationï¼ˆUUIDå±¥æ­´ç®¡ç†ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿çµ±åˆï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ ä¸­ï½é«˜ï¼ˆç”»åƒã¨DBå±¥æ­´ã®å®Œå…¨ãªç´ä»˜ã‘ï¼‰
**æ‰€è¦æ™‚é–“**: 3-4æ™‚é–“
**ä¾å­˜é–¢ä¿‚**: Phase 1Bã¨çµ±åˆæ¨å¥¨

**ç›®çš„**: å„ç”»åƒã«ä¸€æ„ã®UUIDã‚’ç™ºè¡Œã—ã€ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨DBãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«ç´ä»˜ã‘ã€å†ç¾æ€§ã¨è¿½è·¡æ€§ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹

**å®Ÿè£…å†…å®¹**:

1. **UUIDç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **
   ```typescript
   import { randomUUID } from 'crypto';

   // ç”»åƒç”Ÿæˆæ™‚ã«å„ç”»åƒã”ã¨ã«UUIDã‚’ç™ºè¡Œ
   interface ImageRecord {
     uuid: string;           // ä¸€æ„ã®UUIDï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ï¼‰
     filePath: string;       // ä¿å­˜å…ˆãƒ‘ã‚¹
     toolName: string;       // ä½¿ç”¨ã—ãŸãƒ„ãƒ¼ãƒ«
     prompt: string;         // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
     parameters: object;     // å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONï¼‰
     createdAt: Date;        // ç”Ÿæˆæ—¥æ™‚
     model: string;          // ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«
     // ... ãã®ä»–ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
   }
   ```

2. **ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¸ã®UUIDåŸ‹ã‚è¾¼ã¿**
   - **å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
     - PNG: ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ã‚¯ï¼ˆtEXt/zTXtï¼‰ã‚’ä½¿ç”¨
     - JPEG: EXIF UserComment ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨
     - WebP: EXIF/XMP ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨

   - **åŸ‹ã‚è¾¼ã¿ãƒ‡ãƒ¼ã‚¿æ§‹é€ **:
     ```json
     {
       "vertexai_imagen_uuid": "550e8400-e29b-41d4-a716-446655440000",
       "tool_name": "generate_image",
       "prompt": "A serene mountain landscape...",
       "model": "imagen-3.0-generate-001",
       "created_at": "2025-10-12T10:30:00Z",
       "aspect_ratio": "16:9",
       "sample_image_size": "1K",
       "parameters": { /* å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ */ }
     }
     ```

   - **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸å®š**:
     - PNG: `png-chunk-text` ã¾ãŸã¯ `sharp` metadata API
     - JPEG: `piexifjs` ã¾ãŸã¯ `exiftool-vendored`
     - WebP: `sharp` metadata APIï¼ˆWebP EXIFå¯¾å¿œï¼‰
     - æ¨å¥¨: `sharp`ï¼ˆæ—¢ã«ä¾å­˜é–¢ä¿‚ã«ã‚ã‚Šã€çµ±ä¸€çš„ãªAPIï¼‰

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆUUIDãƒ™ãƒ¼ã‚¹ï¼‰**
   ```sql
   CREATE TABLE images (
     -- ç”»åƒã®ä¸€æ„è­˜åˆ¥å­ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨åŒæœŸï¼‰
     uuid TEXT PRIMARY KEY,

     -- åŸºæœ¬æƒ…å ±
     file_path TEXT NOT NULL,
     tool_name TEXT NOT NULL,
     prompt TEXT NOT NULL,
     created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

     -- ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     model TEXT,
     aspect_ratio TEXT,
     sample_count INTEGER,
     sample_image_size TEXT,
     safety_level TEXT,
     person_generation TEXT,
     language TEXT,

     -- å®Œå…¨ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONï¼‰
     parameters TEXT NOT NULL,

     -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
     success BOOLEAN DEFAULT 1,
     error_message TEXT,

     -- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
     file_size INTEGER,
     mime_type TEXT,

     -- æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     prompt_fts TEXT  -- Full-text searchç”¨
   );

   -- ãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ãƒ†ãƒ¼ãƒ–ãƒ«
   CREATE VIRTUAL TABLE images_fts USING fts5(
     uuid, prompt, parameters,
     content='images'
   );

   -- Phase 1B ã¨ã®çµ±åˆæ™‚
   CREATE TABLE jobs (
     id TEXT PRIMARY KEY,
     type TEXT NOT NULL,
     status TEXT NOT NULL,
     params TEXT NOT NULL,
     result TEXT,  -- ç”Ÿæˆã•ã‚ŒãŸUUIDã®é…åˆ—ã‚’å«ã‚€
     error TEXT,
     created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
     started_at DATETIME,
     completed_at DATETIME
   );
   ```

4. **ä¿å­˜å ´æ‰€ï¼ˆæŸ”è»Ÿæ€§é‡è¦–ï¼‰**
   - **å„ªå…ˆé †ä½**:
     1. ç’°å¢ƒå¤‰æ•° `VERTEXAI_IMAGEN_DB`ï¼ˆPhase 1Bã¨çµ±åˆæ™‚ï¼‰
     2. ç’°å¢ƒå¤‰æ•° `VERTEXAI_IMAGEN_HISTORY_DB`ï¼ˆå±¥æ­´ã®ã¿ï¼‰
     3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `./data/vertexai-imagen.db`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ï¼‰
   - **ç†ç”±**:
     - ã‚³ãƒ³ãƒ†ãƒŠ/CIç’°å¢ƒå¯¾å¿œ: ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¾å­˜ã‚’å›é¿
     - ç›¸å¯¾ãƒ‘ã‚¹ä½¿ç”¨å¯èƒ½: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§DBç®¡ç†
     - ç’°å¢ƒå¤‰æ•°ã§æŸ”è»Ÿã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½

5. **ç”»åƒç”Ÿæˆãƒ•ãƒ­ãƒ¼ã®çµ±åˆ**
   ```typescript
   async function generateImage(...) {
     // 1. å„ç”»åƒã«UUIDã‚’ç™ºè¡Œ
     const imageUUIDs = Array.from(
       { length: sample_count },
       () => randomUUID()
     );

     // 2. APIå‘¼ã³å‡ºã—
     const response = await imagenAPI.generate(...);

     // 3. ç”»åƒä¿å­˜ + ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿
     for (let i = 0; i < response.predictions.length; i++) {
       const imageData = response.predictions[i];
       const uuid = imageUUIDs[i];

       // ç”»åƒãƒãƒƒãƒ•ã‚¡ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿
       const imageWithMetadata = await embedMetadata(
         imageData,
         {
           vertexai_imagen_uuid: uuid,
           tool_name: 'generate_image',
           prompt: prompt,
           model: model,
           // ... ãã®ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
         }
       );

       // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
       await fs.writeFile(filePath, imageWithMetadata);

       // 4. DBè¨˜éŒ²
       await db.run(
         'INSERT INTO images (uuid, file_path, ...) VALUES (?, ?, ...)',
         [uuid, filePath, ...]
       );
     }
   }
   ```

6. **æ–°è¦ãƒ„ãƒ¼ãƒ«**
   - `list_history`: å±¥æ­´ä¸€è¦§è¡¨ç¤º
     - ãƒ•ã‚£ãƒ«ã‚¿: tool_name, date_range, model, aspect_ratio
     - ã‚½ãƒ¼ãƒˆ: created_at DESC
     - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
     - å‡ºåŠ›: UUID, prompt, created_at, file_path ãªã©

   - `get_history_by_uuid`: UUIDæŒ‡å®šã§å±¥æ­´è©³ç´°å–å¾—
     - å…¥åŠ›: uuid
     - å‡ºåŠ›: å®Œå…¨ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ç”»åƒãƒ‘ã‚¹ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
     - **DBä¸è¦**: ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚‚æƒ…å ±å–å¾—å¯èƒ½

   - `get_metadata_from_image`: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Š
     - å…¥åŠ›: image_path
     - å‡ºåŠ›: UUIDã€ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
     - ç”¨é€”: DBã«ãªã„ç”»åƒã§ã‚‚æƒ…å ±å–å¾—å¯èƒ½

   - `regenerate_from_uuid`: UUIDæŒ‡å®šã§å†ç”Ÿæˆ
     - å…¥åŠ›: uuid, override_params?
     - å‹•ä½œ: DBã¾ãŸã¯ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— â†’ å†ç”Ÿæˆ
     - å‡ºåŠ›: æ–°ã—ã„ç”»åƒï¼ˆæ–°ã—ã„UUIDã‚’ä»˜ä¸ï¼‰

   - `search_history`: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ¤œç´¢ï¼ˆãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ï¼‰
     - å…¥åŠ›: query, limit?, filters?
     - å‡ºåŠ›: matching UUIDs, previews
     - FTS5ã«ã‚ˆã‚‹é«˜é€Ÿæ¤œç´¢

   - `delete_history`: å±¥æ­´å‰Šé™¤
     - å…¥åŠ›: uuid, delete_file? (default: false)
     - å‹•ä½œ: DBè¨˜éŒ²å‰Šé™¤ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤

   - `sync_metadata_to_db`: ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’DBã«åŒæœŸ
     - å…¥åŠ›: directory?
     - å‹•ä½œ: æŒ‡å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ç”»åƒã‚’ã‚¹ã‚­ãƒ£ãƒ³ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šã€DBæ›´æ–°
     - ç”¨é€”: DBã‚’å¤±ã£ãŸå ´åˆã®å¾©æ—§ã€ä»–ç’°å¢ƒã‹ã‚‰ã®ç”»åƒã‚¤ãƒ³ãƒãƒ¼ãƒˆ

7. **è‡ªå‹•è¨˜éŒ²ãƒ•ãƒ­ãƒ¼**
   ```
   ç”»åƒç”Ÿæˆ â†’ UUIDç™ºè¡Œ â†’ APIå‘¼ã³å‡ºã— â†’ ç”»åƒä¿å­˜ + ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ â†’ DBè¨˜éŒ²
                â†“
   æˆåŠŸ/å¤±æ•—ä¸¡æ–¹ã‚’è¨˜éŒ²ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ä¿å­˜ï¼‰
   ```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- **ç”»åƒã¨DBå±¥æ­´ã®å®Œå…¨ãªç´ä»˜ã‘**: UUIDã«ã‚ˆã‚Šç¢ºå®Ÿã«å¯¾å¿œé–¢ä¿‚ã‚’ä¿è¨¼
- **ç”»åƒå˜ä½“ã§å®Œçµ**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”Ÿæˆæ¡ä»¶ã‚’ç¢ºèªå¯èƒ½ï¼ˆDBä¸è¦ï¼‰
- **æŸ”è»Ÿãªå±¥æ­´ç®¡ç†**: DBã‚’å¤±ã£ã¦ã‚‚ç”»åƒã‹ã‚‰å¾©æ—§å¯èƒ½
- **å†ç¾æ€§ã®ä¿è¨¼**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å®Œå…¨ãªè¨˜éŒ²
- **é«˜åº¦ãªæ¤œç´¢**: ãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã€è¤‡æ•°æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿
- **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã§å•é¡Œã‚’ç‰¹å®šå¯èƒ½
- **ã‚³ã‚¹ãƒˆåˆ†æ**: ç”Ÿæˆå›æ•°ã€ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«ã®çµ±è¨ˆ
- **ãƒãƒ¼ãƒ å…±æœ‰**: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰æ™‚ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚ä¼é”

**è€ƒæ…®äº‹é …**:
- **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º**: å¤§ããªJSONåŸ‹ã‚è¾¼ã¿æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå¢—åŠ ï¼ˆæ•°KBç¨‹åº¦ï¼‰
- **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ãŒç”»åƒã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ï¼ˆç’°å¢ƒå¤‰æ•°ã§ç„¡åŠ¹åŒ–å¯èƒ½ã«ã™ã‚‹ï¼‰
- **äº’æ›æ€§**: å¤ã„ç”»åƒï¼ˆUUIDæœªåŸ‹ã‚è¾¼ã¿ï¼‰ã¸ã®å¯¾å¿œ
  - `sync_metadata_to_db` ã§ãƒ•ã‚¡ã‚¤ãƒ«å/ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã®ç´ä»˜ã‘ã‚’è©¦è¡Œ
  - ã¾ãŸã¯æ‰‹å‹•ã§UUIDè¿½åŠ æ©Ÿèƒ½ã‚’æä¾›

**ç’°å¢ƒå¤‰æ•°è¨­å®š**:
```bash
# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿æœ‰åŠ¹åŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
VERTEXAI_IMAGEN_EMBED_METADATA=true

# åŸ‹ã‚è¾¼ã‚€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ãƒ¬ãƒ™ãƒ«
# "minimal" - UUIDã®ã¿
# "standard" - UUID + ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
# "full" - UUID + å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
VERTEXAI_IMAGEN_METADATA_LEVEL=standard
```

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/utils/metadata.ts`: æ–°è¦ä½œæˆï¼ˆUUIDç”Ÿæˆã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿/èª­ã¿å–ã‚Šï¼‰
- `src/utils/database.ts`: æ–°è¦ä½œæˆï¼ˆSQLiteæ¥ç¶šã€CRUDæ“ä½œã€FTS5æ¤œç´¢ï¼‰
- `src/index.ts`: å„ãƒ„ãƒ¼ãƒ«é–¢æ•°ã«UUIDç®¡ç†ã¨DBè¨˜éŒ²ã‚’çµ±åˆ
- `src/types/tools.ts`: ImageRecord ãªã©ã®å‹å®šç¾©è¿½åŠ 
- `package.json`: ä¾å­˜é–¢ä¿‚è¿½åŠ ï¼ˆ`better-sqlite3` ãªã©ï¼‰

---

### Phase 4: Prompt Templatingï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¢ ä½
**æ‰€è¦æ™‚é–“**: 1-2æ™‚é–“
**ä¾å­˜é–¢ä¿‚**: ãªã—

**ç›®çš„**: å†åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç®¡ç†ã—ã€ä¸€è²«æ€§ã®ã‚ã‚‹ç”»åƒç”Ÿæˆã‚’æ”¯æ´

**å®Ÿè£…å†…å®¹**:

1. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ **
   ```json
   {
     "name": "portrait_template",
     "description": "Professional portrait photo template",
     "template": "A professional portrait of {subject}, {style}, high quality, studio lighting",
     "variables": ["subject", "style"],
     "default_params": {
       "aspect_ratio": "3:4",
       "person_generation": "ALLOW_ADULT"
     },
     "tags": ["portrait", "professional"]
   }
   ```

2. **ä¿å­˜å ´æ‰€ï¼ˆè¦ç´„æ˜ç¢ºåŒ–ï¼‰**
   - **å„ªå…ˆé †ä½**:
     1. ç’°å¢ƒå¤‰æ•° `VERTEXAI_IMAGEN_TEMPLATES_DIR`ï¼ˆæœ€å„ªå…ˆï¼‰
     2. `~/.vertexai-imagen/templates/`ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ«ï¼‰
     3. `./templates/`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
   - **ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼**: JSONï¼ˆ`.json`ï¼‰
   - **å‘½åè¦å‰‡**: `{template_name}.json`
   - **å…±æœ‰ãƒ•ãƒ­ãƒ¼**:
     - ãƒãƒ¼ãƒ å…±æœ‰: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã® `./templates/` ã‚’ git ç®¡ç†
     - å€‹äººç”¨: `~/.vertexai-imagen/templates/` ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé…ç½®
   - **æ¤œç´¢é †åº**: ç’°å¢ƒå¤‰æ•° â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ« â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«

3. **æ–°è¦ãƒ„ãƒ¼ãƒ«**
   - `save_prompt_template`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
     - å…¥åŠ›: name, template, variables, default_params

   - `list_prompt_templates`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§
     - ãƒ•ã‚£ãƒ«ã‚¿: tags, search

   - `get_template_detail`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè©³ç´°å–å¾—
     - å…¥åŠ›: template_name

   - `generate_from_template`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆ
     - å…¥åŠ›: template_name, variable_values
     - ä¾‹: `{subject: "a woman", style: "cinematic"}`
     - å‡ºåŠ›: ç”Ÿæˆç”»åƒ

   - `delete_template`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‰Šé™¤

   - `update_template`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°

4. **å¤‰æ•°ç½®æ›**
   - ã‚·ãƒ³ãƒ—ãƒ«ãªæ–‡å­—åˆ—ç½®æ›: `{variable_name}`
   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: å¿…é ˆå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†åˆ©ç”¨æ€§
- ä¸€è²«æ€§ã®ã‚ã‚‹ç”»åƒç”Ÿæˆ
- ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®å…±æœ‰
- ãƒãƒ¼ãƒ å†…ã§ã®æ¨™æº–åŒ–

**æ‹¡å¼µæ¡ˆ**:
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
- ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰åˆ¥ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‚ç…§ï¼‰

---

## ãã®ä»–ã®æ¤œè¨é …ç›®

### ãƒãƒƒãƒå‡¦ç†
**æ¦‚è¦**: è¤‡æ•°ã®ç•°ãªã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸€æ‹¬å‡¦ç†

**å®Ÿè£…å†…å®¹**:
- `batch_generate`: CSV/JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å…¥åŠ›èª­ã¿è¾¼ã¿
- é€²æ—ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆX/Y å®Œäº†ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆä¸€éƒ¨å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶šï¼‰
- çµæœã®ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**:
- å¤§é‡ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆç”»åƒç”Ÿæˆ
- A/Bãƒ†ã‚¹ãƒˆç”¨ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆ

---

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… Phase 2 ã«çµ±åˆæ¸ˆã¿

UUID-based History Tracking & Metadata Integrationï¼ˆPhase 2ï¼‰ã¨ã—ã¦å®Ÿè£…äºˆå®šã€‚
- å„ç”»åƒã«ä¸€æ„ã®UUIDã‚’ç™ºè¡Œã—ã€ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨DBãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«ç´ä»˜ã‘
- PNG/JPEG/WebP å¯¾å¿œã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿
- DBã‚’å¤±ã£ã¦ã‚‚ç”»åƒã‹ã‚‰å±¥æ­´å¾©æ—§å¯èƒ½

è©³ç´°ã¯ Phase 2 ã‚’å‚ç…§ã€‚

---

### Variationç”Ÿæˆ
**å„ªå…ˆåº¦**: ğŸ”µ æ¤œè¨ä¸­
**æ¦‚è¦**: æ—¢å­˜ç”»åƒã®é¡ä¼¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆseedå€¤ã«ã‚ˆã‚‹æ±ºå®šè«–çš„ç”Ÿæˆï¼‰

**å®Ÿè£…å†…å®¹**:
- `generate_variation`: æ—¢å­˜ç”»åƒã®é¡ä¼¼ç”»åƒç”Ÿæˆ
- seed å€¤ã®åˆ¶å¾¡ï¼ˆImagen API ã¯å¯¾å¿œæ¸ˆã¿ï¼‰
  - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‹: `Uint32`ï¼ˆéè² æ•´æ•°ï¼‰
  - æœ‰åŠ¹ç¯„å›²: 1 ï½ 2,147,483,647
  - ç”¨é€”: æ±ºå®šè«–çš„ãªç”»åƒç”Ÿæˆï¼ˆåŒã˜seed + ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§åŒã˜ç”»åƒç”Ÿæˆï¼‰
- ã¾ãŸã¯å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ è¿½åŠ 

**API åˆ¶ç´„**:
- seed ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `addWatermark: false` ã®å ´åˆã®ã¿ä½¿ç”¨å¯èƒ½
- `enhancePrompt: true` ã®å ´åˆã€seed ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æ©Ÿèƒ½ã—ãªã„
  - ç†ç”±: enhancePrompt ãŒæ–°ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€ç•°ãªã‚‹ç”»åƒãŒç”Ÿæˆã•ã‚Œã‚‹ãŸã‚

**ãƒ¡ãƒªãƒƒãƒˆ**:
- å®Œå…¨ãªå†ç¾æ€§ï¼ˆåŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åŒã˜ç”»åƒã‚’ç”Ÿæˆï¼‰
- A/Bãƒ†ã‚¹ãƒˆå‘ã‘ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
- ãƒ‡ãƒãƒƒã‚°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®¹æ˜“åŒ–

**å°å…¥ã®å®¹æ˜“æ€§**:
- APIå¯¾å¿œç¢ºèªæ¸ˆã¿ã€å®Ÿè£…ã¯æ¯”è¼ƒçš„å®¹æ˜“
- æ—¢å­˜ãƒ„ãƒ¼ãƒ«ã¸ã® seed ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ ã®ã¿ã§å®Ÿç¾å¯èƒ½

---

### ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
**æ¦‚è¦**: PNG/JPEG/WebPé–“ã®å¤‰æ›ã¨åœ§ç¸®æœ€é©åŒ–

**å®Ÿè£…å†…å®¹**:
- `convert_format`: ç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
  - å…¥åŠ›: input_path, output_format, quality
  - Sharp ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ï¼ˆæ—¢ã«ä¾å­˜é–¢ä¿‚ã«ã‚ã‚‹ï¼‰
- åœ§ç¸®æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®æœ€é©åŒ–
- ç”¨é€”ã«å¿œã˜ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé¸æŠ

---

### Safety Filter Customization
**æ¦‚è¦**: ã‚ˆã‚Šç´°ã‹ã„å®‰å…¨æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š

**å®Ÿè£…å†…å®¹**:
- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®é–¾å€¤èª¿æ•´
  - SEXUALLY_EXPLICIT: BLOCK_MEDIUM_AND_ABOVE
  - HATE_SPEECH: BLOCK_ONLY_HIGH
  - HARASSMENT: BLOCK_LOW_AND_ABOVE
  - DANGEROUS_CONTENT: BLOCK_MEDIUM_AND_ABOVE
- ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šï¼ˆstrict, moderate, permissiveï¼‰

**ç¾çŠ¶**: å…¨ã‚«ãƒ†ã‚´ãƒªåŒã˜é–¾å€¤ã‚’ä½¿ç”¨
**æ”¹å–„**: ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ç•°ãªã‚‹é–¾å€¤ã‚’è¨­å®šå¯èƒ½ã«

---

## æ¨å¥¨å®Ÿè£…é †åº

1. **Phase 1A'** (customize_image ãƒãƒ«ãƒã‚µãƒ³ãƒ—ãƒ«) - 30åˆ† âœ… å®Œäº†
   - ç†ç”±: æ—¢å­˜æ©Ÿèƒ½ã¨ã®çµ±ä¸€ã€ä½ãƒªã‚¹ã‚¯

2. **Phase 1C** (è§£åƒåº¦é¸æŠå¯¾å¿œ) - 1æ™‚é–“ â¬…ï¸ æ¬¡ã®å®Ÿè£…æ¨å¥¨
   - ç†ç”±:
     - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã«ã‚ˆã‚‹æ—©æœŸå®Ÿè£…
     - å®Ÿè£…ãŒå®¹æ˜“ã‹ã¤ä½ãƒªã‚¹ã‚¯
     - å…¨ã¦ã®ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã§å“è³ªåˆ¶å¾¡ãŒå¯èƒ½ã«
     - Phase 1B/2 ã®è¤‡é›‘ãªå®Ÿè£…ã®å‰ã«å®Œäº†ã§ãã‚‹å°è¦æ¨¡æ”¹å–„
   - ãƒ¡ãƒªãƒƒãƒˆ: é«˜è§£åƒåº¦ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°é€Ÿåº¦å‘ä¸Š

3. **Phase 1B + Phase 2 çµ±åˆ** (Async Jobs + UUID-based History Tracking) - 7-9æ™‚é–“
   - ç†ç”±:
     - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ã«ã‚ˆã‚‹ä¿¡é ¼æ€§å‘ä¸Šï¼ˆPhase 1Bï¼‰
     - SQLiteçµ±åˆã«ã‚ˆã‚Šå†èµ·å‹•è€æ€§ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹é›†è¨ˆã‚’åŒæ™‚å®Ÿç¾
     - UUID + ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ã«ã‚ˆã‚‹å®Œå…¨ãªè¿½è·¡æ€§ï¼ˆPhase 2ï¼‰
     - ç”»åƒã¨DBå±¥æ­´ã®å®Œå…¨ãªç´ä»˜ã‘ã€å¾©æ—§å¯èƒ½æ€§
   - å®Ÿè£…é †åº: Phase 2ï¼ˆDBè¨­è¨ˆ + UUIDç®¡ç†ï¼‰â†’ Phase 1Bï¼ˆã‚¸ãƒ§ãƒ–ç®¡ç†ï¼‰â†’ çµ±åˆãƒ†ã‚¹ãƒˆ
   - Phase 2 ã®ç‹¬ç«‹å®Ÿè£…ã‚‚å¯èƒ½ï¼ˆ3-4æ™‚é–“ï¼‰

4. **Phase 4** (Templates) - 1-2æ™‚é–“
   - ç†ç”±: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã€ãƒãƒ¼ãƒ å…±æœ‰ãƒ•ãƒ­ãƒ¼æ•´å‚™

5. **ãã®ä»–ã®æ¤œè¨é …ç›®** - é©å®œ
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«åŸºã¥ã„ã¦å„ªå…ˆé †ä½ä»˜ã‘
   - seed ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆVariationç”Ÿæˆï¼‰
   - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ã€ãƒãƒƒãƒå‡¦ç†ãªã©

---

## å‚™è€ƒ

### ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
- Phase 1A: v0.6.0 ã¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹äºˆå®š
- Phase 1A': v0.6.1
- Phase 1C: v0.6.2ï¼ˆè§£åƒåº¦é¸æŠå¯¾å¿œï¼‰
  - sampleImageSize ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ ï¼ˆå…¨ç”Ÿæˆãƒ„ãƒ¼ãƒ«ï¼‰
- Phase 2 å˜ç‹¬: v0.7.0ï¼ˆãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰
  - UUIDç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ã€å±¥æ­´DBã€ãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
- Phase 1B + Phase 2 çµ±åˆ: v0.7.5 ã¾ãŸã¯ v0.8.0ï¼ˆçµ±åˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼‰
  - éåŒæœŸã‚¸ãƒ§ãƒ–ç®¡ç† + UUIDå±¥æ­´ç®¡ç†ã®çµ±åˆ
  - SQLiteçµ±åˆã€å†èµ·å‹•è€æ€§ã€å®Œå…¨ãªè¿½è·¡æ€§
- Phase 4: v0.9.0 ã¾ãŸã¯ v1.0.0

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†å¾Œã€ä»¥ä¸‹ã‚’æ›´æ–°:
- README.md: æ–°æ©Ÿèƒ½ã®èª¬æ˜
- CHANGELOG.md: å¤‰æ›´å±¥æ­´
- RELEASE_NOTES.md: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ

### ãƒ†ã‚¹ãƒˆ
- å„ãƒ•ã‚§ãƒ¼ã‚ºã§æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿæ–½
- å°†æ¥çš„ã«ã¯è‡ªå‹•ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚’æ¤œè¨ï¼ˆvitest ã‚’ä½¿ç”¨ï¼‰

---

**æœ€çµ‚æ›´æ–°**: 2025-10-12
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 1A, Phase 1A' å®Œäº†ã€Phase 1C ãŒæ¬¡ã®å®Ÿè£…å¯¾è±¡ï¼ˆæ—©æœŸå®Ÿè£…æ¨å¥¨ï¼‰
