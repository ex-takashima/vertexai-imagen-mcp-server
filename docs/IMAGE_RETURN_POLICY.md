# 🧩 MCPサーバーにおける画像データ返却方針（Resources API対応）

## 概要
本ドキュメントは、ローカル環境で稼働する TypeScript 製 MCP サーバーにおいて、生成された画像データを **Base64 ではなく URI 経由で返却** する設計方針を定義します。

目的は以下の通りです：

- 大容量画像の通信負荷とトークン消費を回避  
- MCP の **Resources API 仕様** に準拠した返却形式  
- Claude Code / Claude Desktop などローカルクライアントとの高い親和性の確保  

---

## 実装方針：保存 → URI ハンドオフ（推奨方式）

### 基本方針
画像データ本体を直接 Base64 として返すのではなく、サーバー内で生成・保存した画像ファイルを **リソース（resource）として URI 経由で返す**。

1. MCP サーバーが画像を生成  
2. 一時ディレクトリ（例：`/output`）にファイル保存  
3. 保存先を URI としてクライアントに返却（例：`file://...`）  
4. クライアントが `resources/read` 経由で画像データを取得  

この方式により：
- クライアント側のトークン制限や Base64 上限（約1MB）を回避  
- ネットワーク・標準I/O負荷を低減  
- 将来的なストリーミング対応とも整合  

---

## 技術構造

### 1. リソース登録
MCP SDK の `resources` 機能を有効化し、特定ディレクトリ（例：`./output`）を「リソースルート」として登録。  
このディレクトリ以下のファイルは自動的に `file://` URI で参照可能とする。

### 2. ツール返却仕様
ツールの返り値は以下の要素を含める。

| フィールド | 型 | 内容 |
|-------------|----|------|
| `type` | `"text"` | 生成ログまたは通知メッセージ |
| `uri`（または `text` 内） | `file://...` | 保存された画像へのURI |
| `mimeType` | `"image/png"` 等 | クライアントが処理するための MIME 情報 |

> Base64 はプレビュー用の小サイズ画像（サムネイルなど）のみ許可。

### 3. ファイルシステム設計
- 出力先：`/output` ディレクトリなどを指定  
- ファイル名：一意の ID またはタイムスタンプで命名  
- 定期的に不要ファイルを削除（自動クリーンアップ推奨）

---

## クライアント側の挙動

1. クライアント（Claude Code / Desktop）は MCP サーバーから URI を受け取る  
2. `resources/read` 経由で画像を取得  
3. `file://` URI の場合はローカルアクセスで即時プレビュー可能  

> Base64直返却と異なり、会話トークン数に影響せず安定して動作。

---

## 利点と比較

| 項目 | Resources API 方式 | Base64 方式 |
|------|------------------|-------------|
| 通信量 | 小（URI文字列のみ） | 約1.33倍増加 |
| サイズ制限 | 実質なし（ローカルファイル） | 約1MBで制限発生 |
| クライアント互換 | 高（Claude Code / Desktop 対応） | 低（チャットUI依存） |
| ストレージ管理 | 明示的に制御可能 | 不可 |
| 表示速度 | URIアクセスに依存（ほぼ即時） | エンコード・デコード負荷あり |

---

## 運用・拡張指針

### 1. MIME 管理
生成時点で必ず MIME タイプ（例：`image/png`, `image/jpeg`）を明示。  
MCP クライアントはこの値をもとにプレビューやダウンロードを適切に処理する。

### 2. セキュリティ / パス制御
`file://` 経由アクセスはクライアント環境により制限される可能性あり。  
MCP サーバー配下の特定ディレクトリのみを公開対象とする。

### 3. 遅延生成（オプション）
`image://generated/{id}` のような URI テンプレートを導入し、  
`resources/read` 呼び出し時に動的生成・返却を行うことも可能。

### 4. Base64 フォールバック
Resources 非対応クライアント向けに、  
縮小プレビュー（512px程度）を Base64 文字列で返すフォールバックを許可。

---

## テスト項目例

| テスト名 | 検証内容 |
|-----------|-----------|
| ファイル出力確認 | `/output` に画像が正しく保存されるか |
| URI返却確認 | `file://...` 形式の URI が返却されるか |
| Resources参照テスト | クライアントから `resources/read` で取得可能か |
| MIME検証 | `image/png` 等の MIME が正しいか |
| Base64フォールバック | 非対応環境でプレビューが動作するか |

---

## 結論

- **採用方式**：Resources API（URI返却）  
- **対象**：TypeScript 製 MCP サーバー（ローカル動作）  
- **目的**：Base64上限回避・安定動作・標準準拠  
- **特徴**：
  - 保存 → URI 返却の明確な責務分離  
  - クライアント負荷の低減  
  - 高い移植性と拡張性  

---

**最終更新:** 2025-10  
**作成者:** DigiCats 開発ガイドライン  
