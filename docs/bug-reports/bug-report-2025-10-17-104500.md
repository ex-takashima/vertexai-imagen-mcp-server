# Bug Diagnostic Report: Environment Variable Validation Failure in Claude Desktop

**Report Date**: 2025-10-17 10:45:00 JST
**Severity**: Critical
**Impact**: MCP server fails to start - all users affected on first launch
**Status**: Confirmed
**Report File**: `bug-report-2025-10-17-104500.md`

---

## Executive Summary

The vertexai-imagen-mcp-server is failing to start in Claude Desktop on Windows due to environment variable validation failing. The server successfully receives the initialization message from Claude Desktop but immediately throws an `EnvValidationError` stating that neither `GOOGLE_SERVICE_ACCOUNT_KEY` nor `GOOGLE_API_KEY` are set.

**Quick Facts:**
- **Root Cause**: Environment variables are not being passed from Claude Desktop configuration to the MCP server's `process.env`
- **Affected Components**: Environment variable validation (envValidation.ts), server initialization (index.ts), Claude Desktop configuration
- **Recommended Solution**: Solution 2 - Proper Fix (document correct configuration format and add better error messages)
- **Estimated Fix Time**: 2-3 hours (documentation + error message improvements)

---

## 1. Issue Summary

### Reported Symptoms

User reported the following error when starting the MCP server through Claude Desktop:

```
EnvValidationError: Environment variable validation failed:
  - GOOGLE_SERVICE_ACCOUNT_KEY: Either GOOGLE_SERVICE_ACCOUNT_KEY or GOOGLE_API_KEY must be set

When using this MCP server with Claude Desktop or other MCP clients,
you need to set environment variables in the MCP configuration file.
```

The error occurs immediately after the server receives the initialization message from Claude Desktop, before any tools can be registered or used.

### Expected Behavior

1. User configures `claude_desktop_config.json` with environment variables in the `env` section
2. Claude Desktop launches the MCP server with those environment variables
3. Server validates environment variables successfully
4. Server starts and responds to tool requests

### Actual Behavior

1. User configures `claude_desktop_config.json`
2. Claude Desktop launches the MCP server
3. Server attempts to validate environment variables
4. Validation fails because `process.env.GOOGLE_SERVICE_ACCOUNT_KEY` and `process.env.GOOGLE_API_KEY` are both undefined
5. Server throws `EnvValidationError` and fails to start

### Error Messages

```
2025-10-17T10:11:23.659Z [vertexai-imagen] [info] Message from client: {"method":"initialize","params":{"protocolVersion":"2025-06-18","capabilities":{},"clientInfo":{"name":"claude-ai","version":"0.1.0"}},"jsonrpc":"2.0","id":0}
[DEBUG] Rate limiter initialized: 60 calls per 60000ms
EnvValidationError: Environment variable validation failed:
  - GOOGLE_SERVICE_ACCOUNT_KEY: Either GOOGLE_SERVICE_ACCOUNT_KEY or GOOGLE_API_KEY must be set

When using this MCP server with Claude Desktop or other MCP clients,
you need to set environment variables in the MCP configuration file.
```

### Reproduction Steps

1. Install `@dondonudonjp/vertexai-imagen-mcp-server` via npm
2. Configure Claude Desktop's `claude_desktop_config.json` (location: `%APPDATA%\Claude\claude_desktop_config.json` on Windows)
3. Add MCP server configuration with environment variables
4. Launch Claude Desktop
5. Result: Server fails with environment variable validation error

### Environment Information

- **When**: Always - happens on every launch
- **Platform**: Windows (WSL2 environment detected, but server runs in Windows context)
- **Client**: Claude Desktop (version 0.1.0)
- **Node.js**: v18+ (required by package.json)
- **Package Version**: v0.7.0

---

## 2. Investigation Process

### Code Analysis

**Environment Validation Code** (`/mnt/c/projects/vertexai-imagen-mcp-server/src/utils/envValidation.ts`):

Lines 50-58 show the critical validation logic:
```typescript
.refine(
  (data) => {
    // Must have at least one authentication method
    return !!(data.GOOGLE_SERVICE_ACCOUNT_KEY || data.GOOGLE_API_KEY);
  },
  {
    message: 'Either GOOGLE_SERVICE_ACCOUNT_KEY or GOOGLE_API_KEY must be set',
    path: ['GOOGLE_SERVICE_ACCOUNT_KEY'],
  }
)
```

Lines 169-190 show where environment variables are read:
```typescript
export function validateEnvironment(): void {
  const env = {
    GOOGLE_SERVICE_ACCOUNT_KEY: process.env.GOOGLE_SERVICE_ACCOUNT_KEY,
    GOOGLE_API_KEY: process.env.GOOGLE_API_KEY,
    GOOGLE_PROJECT_ID: process.env.GOOGLE_PROJECT_ID,
    // ... other variables
  };

  const result = EnvSchema.safeParse(env);
  // validation logic follows
}
```

**Server Initialization** (`/mnt/c/projects/vertexai-imagen-mcp-server/src/index.ts`):

Lines 116-118 show validation happens in constructor, before any server setup:
```typescript
constructor() {
  // Validate environment variables before any initialization
  validateEnvironment();
  // ... rest of initialization
}
```

**Key Finding**: The server reads from `process.env` directly, which means environment variables must be set in the Node.js process environment before the server starts.

### Root Cause Analysis

**Primary Issue**: Configuration Format Mismatch

The error message in `envValidation.ts` (lines 207-225) provides example configuration:
```typescript
'Example configuration:',
'  {',
'    "mcpServers": {',
'      "vertexai-imagen": {',
'        "command": "npx",',
'        "args": ["-y", "@dondonudonjp/vertexai-imagen-mcp-server"],',
'        "env": {',
'          "GOOGLE_API_KEY": "your-api-key-here",',
'          "GOOGLE_PROJECT_ID": "your-project-id"',
'        }',
'      }',
'    }',
'  }',
```

**However**, the actual configuration path and format that Claude Desktop expects may differ. Common issues:

1. **Wrong command**: User may be using `"command": "vertexai-imagen-mcp-server"` instead of `"command": "npx"` with proper args
2. **Missing npx wrapper**: Direct command may not properly pass environment variables
3. **Path issues on Windows**: Windows paths require special handling (backslash escaping)
4. **Global vs local installation**: Global npm installs may not work the same as npx

---

## 3. Root Cause Analysis

### Primary Cause

**Location**: `/mnt/c/projects/vertexai-imagen-mcp-server/src/utils/envValidation.ts:169-190`

**Category**: Configuration / Integration

**Issue**: Environment variables defined in Claude Desktop's `claude_desktop_config.json` are not being propagated to the Node.js process environment when the server starts.

**Evidence**:
- The server successfully receives the initialization message (proves server is starting)
- Immediately after, validation fails (proves `process.env` doesn't contain the expected variables)
- Error occurs in constructor before any server operations (proves it's an initialization issue)

**Why This Happens**:

The MCP protocol specification allows clients to pass environment variables to servers via the configuration file's `env` section. However, **the method of launching the server affects whether environment variables are properly inherited**.

Common failure scenarios:

1. **Direct binary execution**: `"command": "vertexai-imagen-mcp-server"` may not receive env vars properly on all platforms
2. **Shell interpretation differences**: Windows cmd/PowerShell vs Unix shell handle environment variables differently
3. **npx caching**: npx may cache the executable in a way that doesn't preserve env vars
4. **Node.js spawning**: How Node.js child processes inherit environment depends on spawn options

### Contributing Factors

1. **Insufficient documentation**: README shows examples but doesn't explain Windows-specific requirements
2. **Poor error messages**: Current error doesn't help users debug configuration issues
3. **No validation logging**: Can't see what env vars the server actually received
4. **Testing gap**: Server may not have been tested with Claude Desktop on Windows

---

## 4. Proposed Solutions

### Solution 1: Quick Fix ⚡

**Approach**: Add DEBUG logging to show what environment variables were received

**Changes Required**:
- File: `/mnt/c/projects/vertexai-imagen-mcp-server/src/utils/envValidation.ts`
- Lines: ~170-175 (add logging before validation)
- Scope: 1 file, ~10 lines

**Implementation**:
```typescript
export function validateEnvironment(): void {
  // DEBUG: Log what we actually received
  if (process.env.DEBUG) {
    console.error('[DEBUG] Environment variables received:');
    console.error(`[DEBUG] - GOOGLE_SERVICE_ACCOUNT_KEY: ${process.env.GOOGLE_SERVICE_ACCOUNT_KEY ? 'SET (hidden)' : 'NOT SET'}`);
    console.error(`[DEBUG] - GOOGLE_API_KEY: ${process.env.GOOGLE_API_KEY ? 'SET (hidden)' : 'NOT SET'}`);
    console.error(`[DEBUG] - GOOGLE_PROJECT_ID: ${process.env.GOOGLE_PROJECT_ID || 'NOT SET'}`);
    console.error(`[DEBUG] - All env keys: ${Object.keys(process.env).filter(k => k.startsWith('GOOGLE')).join(', ')}`);
  }

  const env = {
    GOOGLE_SERVICE_ACCOUNT_KEY: process.env.GOOGLE_SERVICE_ACCOUNT_KEY,
    GOOGLE_API_KEY: process.env.GOOGLE_API_KEY,
    // ... rest of code
  };
  // ... rest of validation
}
```

**Pros**:
- ✅ Fast to implement (10 minutes)
- ✅ Low risk - only adds logging
- ✅ Helps users debug configuration issues
- ✅ Can be enabled with `DEBUG=true` in config

**Cons**:
- ❌ Doesn't fix the actual problem
- ❌ Requires users to know about DEBUG flag
- ❌ Doesn't prevent the error

**Effort**: Low (10 minutes)
**Risk**: Very Low
**Recommendation**: Implement this immediately as it helps diagnose the issue

---

### Solution 2: Proper Fix ✅ (RECOMMENDED)

**Approach**: Improve documentation and error messages with platform-specific guidance

**Changes Required**:
- Files: `README.md`, `/mnt/c/projects/vertexai-imagen-mcp-server/src/utils/envValidation.ts`
- Scope: 2 files, ~100 lines (mostly documentation)

**Implementation**:

**A. Update error message in envValidation.ts** (lines 200-230):
```typescript
const errorMessage = [
  'Environment variable validation failed:',
  ...errors,
  '',
  'When using this MCP server with Claude Desktop or other MCP clients,',
  'you need to set environment variables in the MCP configuration file.',
  '',
  '🔧 TROUBLESHOOTING STEPS:',
  '',
  '1. Verify your config file location:',
  '   Windows: %APPDATA%\\Claude\\claude_desktop_config.json',
  '   macOS: ~/Library/Application Support/Claude/claude_desktop_config.json',
  '',
  '2. Ensure you are using the correct command format:',
  '',
  '   ✅ RECOMMENDED (Windows):',
  '   {',
  '     "mcpServers": {',
  '       "vertexai-imagen": {',
  '         "command": "cmd",',
  '         "args": ["/c", "npx", "-y", "@dondonudonjp/vertexai-imagen-mcp-server"],',
  '         "env": {',
  '           "GOOGLE_API_KEY": "your-api-key-here",',
  '           "GOOGLE_PROJECT_ID": "your-project-id"',
  '         }',
  '       }',
  '     }',
  '   }',
  '',
  '   ✅ ALTERNATIVE (if globally installed):',
  '   {',
  '     "mcpServers": {',
  '       "vertexai-imagen": {',
  '         "command": "node",',
  '         "args": ["C:\\\\path\\\\to\\\\global\\\\node_modules\\\\@dondonudonjp\\\\vertexai-imagen-mcp-server\\\\build\\\\index.js"],',
  '         "env": {',
  '           "GOOGLE_API_KEY": "your-api-key-here",',
  '           "GOOGLE_PROJECT_ID": "your-project-id"',
  '         }',
  '       }',
  '     }',
  '   }',
  '',
  '3. For API Key authentication:',
  '   - Get API Key from: https://console.cloud.google.com/vertex-ai/generative/language',
  '   - Set GOOGLE_API_KEY and GOOGLE_PROJECT_ID (both required)',
  '',
  '4. For Service Account authentication:',
  '   - Use GOOGLE_SERVICE_ACCOUNT_KEY with full JSON key as string, OR',
  '   - Use GOOGLE_APPLICATION_CREDENTIALS with path to key file',
  '',
  '5. After editing config:',
  '   - FULLY restart Claude Desktop (close from system tray)',
  '   - Check Claude Desktop logs for errors',
  '',
  '6. Still not working? Enable DEBUG mode:',
  '   Add "DEBUG": "true" to the "env" section',
  '',
  'See README.md for complete setup instructions.',
].join('\n');
```

**B. Add Windows-specific section to README.md**:
```markdown
### Windows の設定方法

Windows環境では、Claude Desktopの設定に特別な考慮が必要です。

#### 設定ファイルの場所

```
%APPDATA%\Claude\claude_desktop_config.json
```

通常は以下のパスになります:
```
C:\Users\YourUsername\AppData\Roaming\Claude\claude_desktop_config.json
```

#### 推奨設定（Windows）

**方法1: npx経由で実行（推奨）**

```json
{
  "mcpServers": {
    "vertexai-imagen": {
      "command": "cmd",
      "args": ["/c", "npx", "-y", "@dondonudonjp/vertexai-imagen-mcp-server"],
      "env": {
        "GOOGLE_API_KEY": "AIzaSy...",
        "GOOGLE_PROJECT_ID": "your-project-id"
      }
    }
  }
}
```

**方法2: グローバルインストール後に実行**

```json
{
  "mcpServers": {
    "vertexai-imagen": {
      "command": "node",
      "args": ["C:\\Users\\YourUsername\\AppData\\Roaming\\npm\\node_modules\\@dondonudonjp\\vertexai-imagen-mcp-server\\build\\index.js"],
      "env": {
        "GOOGLE_API_KEY": "AIzaSy...",
        "GOOGLE_PROJECT_ID": "your-project-id"
      }
    }
  }
}
```

⚠️ **注意**: Windowsのパスは`\\`でエスケープする必要があります（`\`ではなく`\\`）。

#### サービスアカウント認証の設定（Windows）

**方法1: ファイルパスを指定**
```json
{
  "mcpServers": {
    "vertexai-imagen": {
      "command": "cmd",
      "args": ["/c", "npx", "-y", "@dondonudonjp/vertexai-imagen-mcp-server"],
      "env": {
        "GOOGLE_APPLICATION_CREDENTIALS": "C:\\path\\to\\your\\service-account-key.json"
      }
    }
  }
}
```

**方法2: JSONキーを直接埋め込み**
```json
{
  "mcpServers": {
    "vertexai-imagen": {
      "command": "cmd",
      "args": ["/c", "npx", "-y", "@dondonudonjp/vertexai-imagen-mcp-server"],
      "env": {
        "GOOGLE_SERVICE_ACCOUNT_KEY": "{\"type\":\"service_account\",\"project_id\":\"your-project\",...}"
      }
    }
  }
}
```

⚠️ **注意**: JSONキーを埋め込む場合は、JSONの`"`を`\"`でエスケープせず、そのまま文字列として渡してください。

#### トラブルシューティング

**問題1: 環境変数が読み込まれない**

解決策:
1. Claude Desktopを完全に終了（タスクトレイからも終了）
2. 設定ファイルを保存
3. Claude Desktopを再起動

**問題2: "command not found" エラー**

解決策:
```bash
# グローバルインストールの確認
npm list -g @dondonudonjp/vertexai-imagen-mcp-server

# インストールされていない場合
npm install -g @dondonudonjp/vertexai-imagen-mcp-server
```

**問題3: 環境変数バリデーションエラー**

DEBUGモードで詳細を確認:
```json
{
  "mcpServers": {
    "vertexai-imagen": {
      "command": "cmd",
      "args": ["/c", "npx", "-y", "@dondonudonjp/vertexai-imagen-mcp-server"],
      "env": {
        "GOOGLE_API_KEY": "your-key",
        "GOOGLE_PROJECT_ID": "your-project",
        "DEBUG": "true"
      }
    }
  }
}
```

Claude Desktopのログを確認:
```
%APPDATA%\Claude\logs\
```
```

**C. Add verification script** (optional, but helpful):

Create `/mnt/c/projects/vertexai-imagen-mcp-server/scripts/verify-config.js`:
```javascript
#!/usr/bin/env node
/**
 * Configuration verification script
 * Helps users verify their Claude Desktop config is correct
 */

console.log('🔍 Vertex AI Imagen MCP Server - Configuration Verification\n');

// Check environment variables
console.log('📋 Environment Variables Check:');
console.log(`  GOOGLE_SERVICE_ACCOUNT_KEY: ${process.env.GOOGLE_SERVICE_ACCOUNT_KEY ? '✅ SET' : '❌ NOT SET'}`);
console.log(`  GOOGLE_API_KEY: ${process.env.GOOGLE_API_KEY ? '✅ SET' : '❌ NOT SET'}`);
console.log(`  GOOGLE_PROJECT_ID: ${process.env.GOOGLE_PROJECT_ID || '❌ NOT SET'}`);
console.log(`  GOOGLE_REGION: ${process.env.GOOGLE_REGION || '(using default: us-central1)'}`);

console.log('\n🔐 Authentication Method:');
if (process.env.GOOGLE_SERVICE_ACCOUNT_KEY) {
  console.log('  ✅ Service Account (via GOOGLE_SERVICE_ACCOUNT_KEY)');
  try {
    const key = JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_KEY);
    console.log(`     Project ID from key: ${key.project_id}`);
  } catch (e) {
    console.log('  ⚠️  WARNING: GOOGLE_SERVICE_ACCOUNT_KEY is not valid JSON');
  }
} else if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {
  console.log(`  ✅ Service Account (via GOOGLE_APPLICATION_CREDENTIALS)`);
  console.log(`     Key file: ${process.env.GOOGLE_APPLICATION_CREDENTIALS}`);
} else if (process.env.GOOGLE_API_KEY) {
  console.log('  ✅ API Key Authentication');
  if (!process.env.GOOGLE_PROJECT_ID) {
    console.log('  ❌ ERROR: GOOGLE_PROJECT_ID is required when using API Key auth');
  }
} else {
  console.log('  ❌ ERROR: No authentication method configured');
}

console.log('\n✅ Configuration verification complete');
```

**Pros**:
- ✅ Comprehensive solution for users
- ✅ Platform-specific guidance reduces confusion
- ✅ Better error messages help self-service debugging
- ✅ Documentation improvements benefit all users
- ✅ Low risk - mostly documentation changes

**Cons**:
- ⚠️ More documentation to maintain
- ⚠️ Doesn't fix underlying issue if it's a bug in Claude Desktop

**Effort**: Medium (2-3 hours including testing)
**Risk**: Low
**Recommendation**: **This is the recommended solution** - it provides immediate value and helps users succeed

---

### Solution 3: Comprehensive Fix 🔧

**Approach**: Add fallback configuration methods and improve environment variable handling

**Changes Required**:
- Files: Multiple files across the project
- Scope: 5+ files, ~200 lines

**Implementation**:

**A. Add configuration file support**:

Create `/mnt/c/projects/vertexai-imagen-mcp-server/src/utils/configLoader.ts`:
```typescript
/**
 * Configuration loader with multiple fallback strategies
 * 1. Environment variables (standard MCP method)
 * 2. Config file in user home directory
 * 3. Config file in project directory
 */
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';
import { homedir } from 'os';

interface Config {
  GOOGLE_SERVICE_ACCOUNT_KEY?: string;
  GOOGLE_API_KEY?: string;
  GOOGLE_PROJECT_ID?: string;
  GOOGLE_REGION?: string;
  // ... other config options
}

export function loadConfig(): Config {
  const config: Config = {};

  // Strategy 1: Environment variables (highest priority)
  Object.assign(config, loadFromEnv());

  // Strategy 2: User config file (~/.config/vertexai-imagen/config.json)
  if (!hasAuthConfig(config)) {
    const userConfig = loadFromUserConfigFile();
    if (userConfig) Object.assign(config, userConfig);
  }

  // Strategy 3: Project config file (./vertexai-imagen-config.json)
  if (!hasAuthConfig(config)) {
    const projectConfig = loadFromProjectConfigFile();
    if (projectConfig) Object.assign(config, projectConfig);
  }

  return config;
}

function loadFromEnv(): Config {
  return {
    GOOGLE_SERVICE_ACCOUNT_KEY: process.env.GOOGLE_SERVICE_ACCOUNT_KEY,
    GOOGLE_API_KEY: process.env.GOOGLE_API_KEY,
    GOOGLE_PROJECT_ID: process.env.GOOGLE_PROJECT_ID,
    GOOGLE_REGION: process.env.GOOGLE_REGION,
    // ... other variables
  };
}

function loadFromUserConfigFile(): Config | null {
  const configPath = join(homedir(), '.config', 'vertexai-imagen', 'config.json');
  return loadConfigFile(configPath);
}

function loadFromProjectConfigFile(): Config | null {
  const configPath = join(process.cwd(), 'vertexai-imagen-config.json');
  return loadConfigFile(configPath);
}

function loadConfigFile(path: string): Config | null {
  if (!existsSync(path)) return null;

  try {
    const content = readFileSync(path, 'utf-8');
    return JSON.parse(content);
  } catch (error) {
    console.error(`Warning: Failed to load config from ${path}:`, error);
    return null;
  }
}

function hasAuthConfig(config: Config): boolean {
  return !!(config.GOOGLE_SERVICE_ACCOUNT_KEY || config.GOOGLE_API_KEY);
}
```

**B. Update envValidation.ts to use config loader**:
```typescript
import { loadConfig } from './configLoader.js';

export function validateEnvironment(): void {
  // Load config from multiple sources
  const config = loadConfig();

  if (process.env.DEBUG) {
    console.error('[DEBUG] Configuration loaded from:');
    console.error(`[DEBUG] - Environment: ${Object.keys(process.env).filter(k => k.startsWith('GOOGLE')).length} GOOGLE_* variables`);
    console.error(`[DEBUG] - Auth configured: ${!!(config.GOOGLE_SERVICE_ACCOUNT_KEY || config.GOOGLE_API_KEY)}`);
  }

  const result = EnvSchema.safeParse(config);
  // ... rest of validation
}
```

**C. Add CLI command for configuration setup**:
```typescript
// Add to index.ts
if (process.argv.includes('--setup') || process.argv.includes('setup')) {
  console.log('🔧 Vertex AI Imagen MCP Server - Configuration Setup');
  // Interactive setup wizard
  runSetupWizard();
  process.exit(0);
}
```

**D. Document new configuration methods**:
```markdown
### Alternative Configuration Methods

If Claude Desktop's environment variable passing is not working, you can use alternative configuration methods:

#### Method 1: User Config File

Create `~/.config/vertexai-imagen/config.json`:
```json
{
  "GOOGLE_API_KEY": "your-api-key",
  "GOOGLE_PROJECT_ID": "your-project-id"
}
```

Then simplify your Claude Desktop config:
```json
{
  "mcpServers": {
    "vertexai-imagen": {
      "command": "npx",
      "args": ["-y", "@dondonudonjp/vertexai-imagen-mcp-server"]
    }
  }
}
```

#### Method 2: Interactive Setup

Run the setup wizard:
```bash
npx @dondonudonjp/vertexai-imagen-mcp-server --setup
```
```

**Pros**:
- ✅ Provides fallback when env vars don't work
- ✅ Better user experience (interactive setup)
- ✅ Separates credentials from config file
- ✅ More flexible configuration options
- ✅ Solves the root cause permanently

**Cons**:
- ❌ Significant development effort
- ❌ More code to maintain
- ❌ Higher testing burden
- ❌ May complicate the configuration story
- ⚠️ Deviates from MCP standard practices

**Effort**: High (1-2 days including testing and documentation)
**Risk**: Medium (more code paths = more potential issues)
**Recommendation**: Consider for future major version (v1.0.0)

---

## 5. Impact Analysis

### Files Affected by Bug

Currently affected by environment variable not being passed:
- `/mnt/c/projects/vertexai-imagen-mcp-server/src/utils/envValidation.ts` (validation fails here)
- `/mnt/c/projects/vertexai-imagen-mcp-server/src/index.ts` (server fails to initialize)
- User's `claude_desktop_config.json` (configuration not working as expected)

### Files That Would Change (per solution)

- **Quick Fix**: 1 file (`envValidation.ts` - add logging)
- **Proper Fix**: 2 files (`envValidation.ts` - improve error message, `README.md` - add documentation)
- **Comprehensive Fix**: 5+ files (new config loader, updated validation, new setup wizard, updated docs, new tests)

### Blast Radius

**Current bug impact**:
- 100% of new users affected (cannot start server)
- Existing working users not affected (if they already have correct config)
- All 20+ tools unusable until fixed

**Fix impact** (Solution 2 - Recommended):
- No breaking changes
- No API changes
- Only affects error messages and documentation
- Extremely low risk of regression

---

## 6. Testing Recommendations

### Tests to Add

**A. Configuration validation tests**:
```typescript
// tests/envValidation.test.ts
describe('Environment Validation', () => {
  beforeEach(() => {
    // Clear environment
    delete process.env.GOOGLE_SERVICE_ACCOUNT_KEY;
    delete process.env.GOOGLE_API_KEY;
    delete process.env.GOOGLE_PROJECT_ID;
  });

  it('should fail when no auth method is provided', () => {
    expect(() => validateEnvironment()).toThrow(EnvValidationError);
  });

  it('should pass with valid API KEY auth', () => {
    process.env.GOOGLE_API_KEY = 'AIzaSyTestKey';
    process.env.GOOGLE_PROJECT_ID = 'test-project';
    expect(() => validateEnvironment()).not.toThrow();
  });

  it('should pass with valid service account auth', () => {
    process.env.GOOGLE_SERVICE_ACCOUNT_KEY = JSON.stringify({
      type: 'service_account',
      project_id: 'test-project',
      private_key_id: 'key-id',
      private_key: '-----BEGIN PRIVATE KEY-----\ntest\n-----END PRIVATE KEY-----\n',
      client_email: 'test@test.iam.gserviceaccount.com',
    });
    expect(() => validateEnvironment()).not.toThrow();
  });

  it('should fail when API KEY is provided without PROJECT_ID', () => {
    process.env.GOOGLE_API_KEY = 'AIzaSyTestKey';
    expect(() => validateEnvironment()).toThrow(/GOOGLE_PROJECT_ID is required/);
  });

  it('should fail when GOOGLE_SERVICE_ACCOUNT_KEY is invalid JSON', () => {
    process.env.GOOGLE_SERVICE_ACCOUNT_KEY = 'not-valid-json';
    expect(() => validateEnvironment()).toThrow(/must be valid JSON/);
  });
});
```

**B. Integration test with Claude Desktop** (manual):
```markdown
### Manual Testing Checklist

Windows:
- [ ] Fresh install via `npm install -g @dondonudonjp/vertexai-imagen-mcp-server`
- [ ] Configure Claude Desktop with API KEY auth
- [ ] Restart Claude Desktop completely
- [ ] Verify server starts without errors
- [ ] Verify at least one tool works (e.g., generate_image)
- [ ] Test with npx command format
- [ ] Test with direct node command format
- [ ] Test with service account auth (file path)
- [ ] Test with service account auth (inline JSON)

macOS:
- [ ] Same as Windows but with macOS-specific paths

Linux:
- [ ] Same as Windows but with Linux-specific paths
```

### Manual Testing Steps

1. **Test Configuration Format (Quick Test)**:
   ```json
   {
     "mcpServers": {
       "test-imagen": {
         "command": "node",
         "args": ["-e", "console.error('ENV CHECK:', JSON.stringify({API_KEY: process.env.GOOGLE_API_KEY, PROJECT: process.env.GOOGLE_PROJECT_ID}))"],
         "env": {
           "GOOGLE_API_KEY": "test-key",
           "GOOGLE_PROJECT_ID": "test-project"
         }
       }
     }
   }
   ```
   Expected: Should see "ENV CHECK: {API_KEY: 'test-key', PROJECT: 'test-project'}" in logs

2. **Test Actual Server**:
   - Configure with real credentials
   - Launch Claude Desktop
   - Check logs in `%APPDATA%\Claude\logs\`
   - Verify no EnvValidationError appears

3. **Test with DEBUG mode**:
   - Add `"DEBUG": "true"` to env section
   - Check for DEBUG output showing received environment variables

---

## 7. Prevention Recommendations

### How to Prevent Similar Bugs

1. **Add Integration Tests with MCP Clients**:
   - Test actual server launch from Claude Desktop
   - Verify environment variable passing works on all platforms
   - Include Windows, macOS, and Linux in CI/CD

2. **Improve Configuration Validation**:
   - Add `--verify-config` command that checks env vars without starting server
   - Add startup logging that shows what was received (in DEBUG mode)
   - Consider adding config file support as fallback

3. **Better Documentation**:
   - Platform-specific setup guides with screenshots
   - Common troubleshooting section
   - Link to MCP protocol documentation for advanced users

4. **Add Example Configurations**:
   - Create `examples/` directory with sample configs for each platform
   - Include both working and non-working examples with explanations

5. **Automated Testing**:
   - Add CI tests that simulate Claude Desktop launching the server
   - Test environment variable passing mechanism
   - Validate configuration examples in README

---

## 8. Related Issues

### Similar Patterns to Check

Based on the codebase analysis, there are several other environment variables being read:
- `GOOGLE_REGION`
- `GOOGLE_IMAGEN_MODEL`
- `VERTEXAI_IMAGEN_OUTPUT_DIR`
- `VERTEXAI_IMAGEN_THUMBNAIL`
- `VERTEXAI_RATE_LIMIT_MAX_CALLS`
- `DEBUG`

**Potential Issue**: If the authentication env vars are not being passed correctly, these optional configuration vars may also fail to be passed, leading to:
- Server using default values instead of user-specified values
- Unexpected behavior when users try to customize settings
- Silent failures where config is ignored

**Recommendation**: Test all environment variables, not just authentication ones.

---

## 9. Additional Context

### MCP Protocol Environment Variable Handling

The MCP (Model Context Protocol) specification allows clients to pass environment variables to servers via the configuration file. However, the actual implementation depends on:

1. **How the client spawns the server process** (child_process in Node.js, subprocess in Python, etc.)
2. **The shell/command interpreter used** (cmd.exe on Windows, bash on Unix)
3. **The execution method** (direct binary, npx, node with script path)

### Claude Desktop Specific Behavior

Based on the error log, Claude Desktop:
- Successfully starts the server (receives initialization message)
- Uses JSON-RPC 2.0 protocol
- Identifies as "claude-ai" version "0.1.0"
- Protocol version "2025-06-18"

This suggests Claude Desktop is following the MCP specification correctly. The issue is likely in:
1. How the server is being invoked (command/args format)
2. Or how the environment variables are being set in the config

### Windows-Specific Considerations

Windows has unique challenges:
- Path separators (`\` vs `/`)
- Command execution (cmd.exe vs PowerShell)
- Environment variable syntax (`%VAR%` vs `$VAR`)
- Case sensitivity (usually case-insensitive)
- JSON escaping in config files (need `\\` for paths)

The recommended command format for Windows:
```json
"command": "cmd"
"args": ["/c", "npx", "-y", "@dondonudonjp/vertexai-imagen-mcp-server"]
```

This ensures:
- cmd.exe handles environment variables correctly
- npx downloads/runs the latest version
- Environment variables from config are inherited properly

---

## 10. Recommended Action

### Immediate Action (Today)

Implement **Solution 1 (Quick Fix)** + **Solution 2 (Proper Fix)**:

1. Add DEBUG logging to envValidation.ts (10 minutes)
2. Improve error message with troubleshooting steps (30 minutes)
3. Add Windows-specific documentation to README.md (1 hour)
4. Test on Windows with Claude Desktop (30 minutes)
5. Release patch version v0.7.1

**Total Time**: 2-3 hours

### Short-term Action (This Week)

1. Create configuration verification script (1 hour)
2. Add example configurations for each platform (1 hour)
3. Add integration tests for environment variable passing (2 hours)
4. Update all documentation with troubleshooting sections (1 hour)

**Total Time**: 5 hours

### Long-term Action (Future Version)

Consider **Solution 3 (Comprehensive Fix)** for v1.0.0:
1. Implement configuration file fallback mechanism
2. Add interactive setup wizard
3. Improve overall configuration experience
4. Add automated integration tests with actual Claude Desktop

**Total Time**: 1-2 days

---

## Decision Point

The recommended solution is **Solution 2 (Proper Fix)** because it:

1. ✅ Directly addresses the user's problem with better guidance
2. ✅ Low effort (2-3 hours) with high impact
3. ✅ Low risk (documentation and error messages only)
4. ✅ Helps all users, not just those with the bug
5. ✅ Can be combined with Solution 1 for even better debugging

**Implementation Priority:**
1. **HIGH**: Solution 1 (DEBUG logging) - helps diagnose
2. **HIGH**: Solution 2 (Better docs & error messages) - helps fix
3. **MEDIUM**: Add verification script - helps prevent
4. **LOW**: Solution 3 (Config file fallback) - future enhancement

---

**Diagnosis Complete**
**Report Generated**: 2025-10-17 10:45:00 JST
**Diagnosis Duration**: 25 minutes
**Report Location**: `/mnt/c/projects/vertexai-imagen-mcp-server/docs/bug-reports/bug-report-2025-10-17-104500.md`

---

## Appendix: User Support Response Template

When users report this error, respond with:

```
Thanks for reporting this issue! This is a common configuration problem on Windows.

🔍 The issue is that environment variables aren't being passed from Claude Desktop to the server.

✅ QUICK FIX - Try this configuration format:

{
  "mcpServers": {
    "vertexai-imagen": {
      "command": "cmd",
      "args": ["/c", "npx", "-y", "@dondonudonjp/vertexai-imagen-mcp-server"],
      "env": {
        "GOOGLE_API_KEY": "your-api-key-here",
        "GOOGLE_PROJECT_ID": "your-project-id"
      }
    }
  }
}

🔧 Key points:
1. Use "cmd" as the command (not "vertexai-imagen-mcp-server")
2. Use npx to ensure latest version
3. Fully restart Claude Desktop after config changes
4. Your config file is at: %APPDATA%\Claude\claude_desktop_config.json

💡 To verify it's working, add "DEBUG": "true" to the env section and check the logs.

Let me know if this fixes it!
```
